TRAPS	OVER/UNDERFLOW TRAP ROUTINE	MACRO %53B(1156)-1 01:12 26-Jul-84 Page 1
TRAPS	MAC	 7-Mar-73 08:12		V32/01	14-SEP-72	/DLH

     1					TITLE TRAPS	OVER/UNDERFLOW TRAP ROUTINE
     2					SUBTTL	V32/01	14-SEP-72	/DLH
     3
     4					;FROM V.32(305)	6-OCT-1971	T. EGGERS/DMN/TWE
     5					;***COPYRIGHT 1969,1970,1971,1972 DIGITAL EQUIPMENT CORP., MAYNARD, MASS.***
     6
     7			000000		REENT==0	;TRAPS WILL NOT LOAD INTO HIGH SEGMENT
     8
     9			000014		T=14	;WORKING ACCUMULATOR
    10			000001		TT=1
    11			000000		IFE REENT,<LOW=0>
    12					IFN REENT,<LOW=16>
    13			000017		P=17	;PUSH DOWN POINTER
    14
    15		000100	000000		FXU=1B11	;FLOATING EXPONENT UNDERFLOW FLAG
    16		040000	000000		FOV=1B3		;FLOATING OVERFLOW BIT
    17		000040	000000		NDV=1B12	;NO DIVIDE BIT
    18
    19			000010		OVE=10		;ENABLE INTEGER OVERFLOW TRAPS
    20
    21					;RESTRICTIONS ON OVTRAP ROUTINE:
    22					;	1- NO ANSWER FOR A TRAPPING INSTRUCTION MUST BE STORED,
    23					;	   INDEXED BY 17, OFF THE END OF THE PUSH DOWN LIST WHOSE
    24					;	   POINTER IS IN 17.
    25					;	2- OVTRAP DOES NOT TRACE XCT OR UUO CHAINS
    26					;	3- THERE ARE NO FIXUPS FOR INTEGER TRAPS
    27					;	4- MOVNX AND MOVMX ARE CONSIDERED INTEGER INSTRUCTIONS
    28					;	5- TRAPPING INSTRUCTION MUST NOT BE IN ACCUMULATOR T=14
    29					;	6- CRY0 AND CRY1 WILL BE PRESERVED
    30					;	7- THE UN-NORMALIZING OF UNDERFLOWS WILL NOT WORK FOR THE
    31					;	   FLOATING "LONG" MODE OR KI10 D.P. INSTRUCTIONS.
    32
    33					IF1,<OPDEF KADFN [DFN]>	;THIS PRESERVES THE KA10 "DFN"
    34								;   SINCE SEARCH DEF40 REDIFINES IT FOR THE KI10
    35
    36					SEARCH	DEF40
    37					ENTRY	TRPIN.,TIMER,INTAB.
    38						EXTERN	.JBCNI
    39					EXTERN	OVPC.,OVCNT.
    40					EXTERN	.JBTPC,.JBAPR,.JBREL,ITYPM.,UUOL.,KA10.
    41
    42					MLON	;ENABLE MULTI LINE LITERALS
    43
    44								;PUSHJ P,TRPINI	TO INITIALIZE ALL TRAPPING
    45	000000'	332 00 0 00 000000*	TRPIN.:	SKIPE	KA10.(LOW)	;KA-10 OR KI-10 PROCESSOR
    46	000001'	254 00 0 00 000021'		JRST	KATRAP		;KA-10 INTERRUPT SYSTEM
    47	000002'	201 01 0 00 000342'		MOVEI	TT,INTAB.	;BASE ADDRESS OF INTERRUPT TABLE
    48	000003'	505 01 0 00 000004 		HRLI	TT,4		;CLEAR INTERRUPT SYSTEM
    49	000004'	047 01 0 00 777745 		INTADR	TT,		;INIT INTERRUPT SYSTEM
    50	000005'	254 04 0 00 000000 		HALT
    51	000006'	515 01 0 00 000002 		HRLZI	TT,2		;REENABLE INTERRUPT SYSTEM
    52	000007'	047 01 0 00 777745 		INTADR	TT,
    53	000010'	254 04 0 00 000000 		HALT
    54	000011'	525 01 0 00 777777 		HRLOI	TT,777777
    55	000012'	047 01 0 00 777744 		INTENB	TT,		;ENABLE ALL CHANNELS
TRAPS	OVER/UNDERFLOW TRAP ROUTINE	MACRO %53B(1156)-1 01:12 26-Jul-84 Page 1-1
TRAPS	MAC	 7-Mar-73 08:12		V32/01	14-SEP-72	/DLH

    56	000013'	254 04 0 00 000000 		HALT
    57	000014'	200 01 0 00 000450'		MOVE	TT,[JSR OVTRAP]	;TRAP1 INSTRUCTION
    58	000015'	047 01 0 00 777740 		SETTR1 TT,		;INIT OVERFLOW TRAPPING
    59	000016'	254 04 0 00 000000 		HALT
    60	000017'	402 00 0 00 000000*		SETZM OVCNT.(LOW)	;INIT # OVERFLOWS TO 0
    61	000020'	263 17 0 00 000000 		POPJ	P,		;RETURN
    62	000021'	201 01 0 00 000031'	KATRAP:	MOVEI TT,OVTRAP+1
    63	000022'	552 01 0 00 000000*		HRRZM TT,.JBAPR		;INIT OVERFLOW TRAP ADDRESS
    64	000023'	201 01 0 00 400010 		MOVEI TT,OVE+400000
    65	000024'	254 02 1 00 000451'		JRSTF @[XWD 004000,.+1]		;CLEAR APR FLAGS
    66	000025'	047 01 0 00 000016 		APRENB TT,		;INIT OVERFLOW TRAPPING
    67	000026'	402 00 0 00 000017*		SETZM OVCNT.(LOW)	;INIT # OVERFLOWS TO 0
    68	000027'	263 17 0 00 000000 		POPJ	P,		;RETURN
    69
    70	000030'	000000	000000		OVTRAP:	0
    71	000031'	254 02 1 00 000452'		JRSTF	@[XWD 004000,.+1]
    72	000032'	202 14 0 00 000336'		MOVEM T,TSAVE		;SAVE AC T
    73	000033'	336 00 0 00 000000*		SKIPN	KA10.(LOW)	;KA-10 OR KI-10
    74	000034'	254 00 0 00 000053'		JRST	CONT		;KI-10. TIMER NOT ON SAME INTERRUPT
    75	000035'	200 00 0 00 000000*		MOVE	0,.JBTPC	;PROGRAM COUNTER AT INTERRUPT TIME
    76	000036'	202 00 0 00 000030'		MOVEM	0,OVTRAP	;PUT WHERE KI-100 PUTS IT
    77	000037'	336 00 0 00 000334'		SKIPN	MAXTIM		;TEST IF CLOCK TRAPPING
    78	000040'	254 00 0 00 000053'		JRST	CONT		;NO - NORMAL PATH
    79	000041'	200 14 0 00 000000*		MOVE	T,.JBCNI	;GET APR STATUS
    80	000042'	602 14 0 00 200110 		TRNE	T,200110	;OVERFLOW?
    81	000043'	254 00 0 00 000053'		JRST	CONT		;YES - NORMAL PATH
    82	000044'	350 14 0 00 000335'		AOS	T,NOWTIM	;INCREMENT TICK COUNTR
    83	000045'	311 14 0 00 000334'		CAML	T,MAXTIM	;TIME ELAPSED?
    84	000046'	254 00 0 00 000332'		JRST	NOTIME		;YES - ERROR MSG
    85	000047'	254 02 1 00 000453'		JRSTF	@[XWD 004000,.+1] ;CLEAR APR FLAGS
    86	000050'	541 14 0 00 401010 		HRRI	T,401010	;SET CLOCK AND OVERFLOW TRAPS
    87	000051'	047 14 0 00 000016 		APRENB	T,		;ENABLE
    88	000052'	254 00 0 00 000240'		JRST	GO
    89	000053'	370 14 0 00 000030'	CONT:	SOS T,OVTRAP		;MAKE JOBTPC POINT TO INSTRUCTION
    90	000054'	202 14 0 00 000000*		MOVEM T,OVPC.(LOW)	;SAVE PC WORD
    91	000055'	607 14 0 00 000100 		TLNN T,(FXU)		;FLOATING POINT UNDERFLOW?
    92	000056'	254 00 0 00 000072'		JRST OVTRP1		;NO
    93
    94	000057'	500 14 0 14 000001 		HLL T,1(T)		;YES
    95	000060'	641 14 0 00 255002 		TLC T,(JFCL (2))	; IS NEXT INSTRUCTION
    96	000061'	607 14 0 00 777002 		TLNN T,777002		;   A JFCL (2) ?
    97	000062'	254 00 0 00 000074'		JRST OVTRP2		;YES
    98
    99	000063'	135 14 0 00 000454'		LDB T,[POINT 9,(T),8]	;GET INSTRUCTION
   100	000064'	303 14 0 00 000177 		CAILE T,177		;POSSIBLE FLOATING POINT?
   101	000065'	254 00 0 00 000226'		JRST TJFCL1		;NO
   102	000066'	305 14 0 00 000140 		CAIGE T,140		;BETWEEN 140 AND 177?
   103						JRST	[CAIN T,(<FSC>_-9)	;NO, FSC?
   104							JRST UAC		;YES
   105										;(UFA AND DFN CAN'T CAUSE UNDERFLOW)
   106						IFN KI10,<TRZ T,003		;CHANGE ALL KI10 D.P. ARITH TO DFAD
   107							CAIN T,(<DFAD>_-9)
   108							JRST UACLNG >		;DFAD, DFSB, DFMP, DFDV
   109	000067'	254 00 0 00 000455'			JRST TJFCL1]		;NO, PRINT ERROR MESSAGE
   110	000070'	405 14 0 00 000007 		ANDI T,7		;MASK TO MODE BITS
TRAPS	OVER/UNDERFLOW TRAP ROUTINE	MACRO %53B(1156)-1 01:12 26-Jul-84 Page 1-2
TRAPS	MAC	 7-Mar-73 08:12		V32/01	14-SEP-72	/DLH

   111	000071'	254 00 0 14 000175'		JRST UTBL(T)		;DISPATCH ON INSTRUCTION TYPE
   112
   113
TRAPS	OVER/UNDERFLOW TRAP ROUTINE	MACRO %53B(1156)-1 01:12 26-Jul-84 Page 2
TRAPS	MAC	 7-Mar-73 08:12		V32/01	14-SEP-72	/DLH

   114	000072'	607 14 0 00 040000 	OVTRP1:	TLNN T,(FOV)		;FLOATING OVERFLOW OR FLOATING DIVIDE CHECK?
   115	000073'	254 00 0 00 000226'		JRST TJFCL1		;NO, INTEGER OVERFLOW OR DIVIDE CHECK
   116	000074'	135 14 0 00 000463'	OVTRP2:	LDB T,[POINT 4,@OVTRAP,12]	;GET AC FIELD
   117	000075'	202 14 0 00 000337'		MOVEM T,ACFLD		;SAVE AC FIELD
   118	000076'	200 14 1 00 000030'		MOVE T,@OVTRAP		;GET INSTRUCTION
   119	000077'	202 14 0 00 000341'		MOVEM T,INST
   120	000100'	200 14 0 00 000336'		MOVE T,TSAVE
   121	000101'	201 14 1 00 000341'		MOVEI T,@INST		;GET EFFECTIVE ADDRESS
   122	000102'	250 14 0 00 000341'		EXCH T,INST		; AND SAVE. PICK UP INSTRUCTION
   123	000103'	641 14 0 00 042000 		TLC T,(042B8)		;CHANGE "MODE 2" TO "MODE 0"
   124									; AND CHANGE 140-177
   125									;   TO 100-137
   126	000104'	544 14 0 00 000030'		HLR T,OVTRAP		;GET FLAGS IN RIGHT HALF
   127	000105'	612 14 0 00 000464'		TDNE T,[643B8+<NDV_-^D18>]	;SKIP FOR "TO MEMORY" AND NO NDV
   128									; NO SKIP FOR INSTRUCTIONS OUTSIDE 140-177
   129									;  (E.G. FSC,XCT,UFA,DFAD,DFSB,DFMP,DFDV)
   130	000106'	334 14 0 00 000337'		SKIPA T,ACFLD		;GET CORRECT SIGN FROM AC
   131	000107'	200 14 0 00 000341'		MOVE T,INST		;GET CORRECT SIGN FROM MEMORY
   132	000110'	202 14 0 00 000340'		MOVEM T,ACDATA		;SAVE ADDRESS FOR SIGN OF CORRECT RESULT
   133	000111'	200 14 0 00 000030'		MOVE T,OVTRAP		;IS THIS AN UNDERFLOW THAT
   134	000112'	603 14 0 00 000100 		TLNE T,(FXU)		;  NEEDS TO BE UNNORMALIZED?
   135						JRST	[MOVE T,TSAVE	;YES, RESTORE T AND
   136							MOVE T,@ACDATA	;  GET ANSWER THAT NEEDS UN-NORMALIZING
   137							PUSH P,TT	;SAVE ANOTHER AC
   138							HLRE TT,T	;GET EXPONENT WITH EXTENDED SIGN INTO
   139							ASH TT,-9	;  RIGHT 8 BITS
   140							TSCE TT,TT	;FOR NEGATIVE ARG, GET 1'S COMPLEMENT
   141									;OF EXPONENT AND DON'T SKIP
   142							TLOA T,777000	;FOR NEG. ARG, SET EXP TO ALL ONES
   143							TLZ T,777000	;FOR POS. ARG, SET EXP TO ALL 0'S
   144							CAMGE TT,[346,,346]	;WILL ALL FRACTION BITS GO AWAY?
   145							TDZA T,T		;YES, FRACTION SHOULD BE ZERO
   146							ASH T,400000(TT)	;UN-NORMALIZE FRACTION TO BRING EXP
   147									;BACK INTO RANGE
   148							POP P,TT	;RESTORE THE AC
   149	000113'	254 00 0 00 000466'			JRST OVTRP3]	;GO STORE RESULT
   150	000114'	200 14 0 00 000336'		MOVE T,TSAVE
   151	000115'	335 00 1 00 000340'		SKIPGE @ACDATA		;SKIP IF CORRECT RESULT IS POSITIVE
   152	000116'	334 14 0 00 000503'		SKIPA T,[XWD 400000,1]	;NO, NEGATIVE
   153	000117'	525 14 0 00 377777 		HRLOI T,377777		;YES
   154	000120'	2 0 00 000014 	OVTRP3:	PUSH P,T		;SAVE FIX UP
   155	000121'	135 14 0 00 000504'		LDB T,[POINT 9,@OVTRAP,8]	;GET INSTRUCTION
   156	000122'	307 14 0 00 000177 		CAIG T,177
   157	000123'	305 14 0 00 000140 		CAIGE T,140		;NORMAL FLOATING POINT INSTRUCTION
   158						JRST	[CAIN T,(<FSC>_-9)	;NO, FSC?
   159							JRST AC		;YES
   160							CAIN T,(<UFA>_-9)	;UFA?
   161							JRST AC1
   162							POP P,ACDATA	;GET SIGN OF RESULT OFF PDL
   163						IFN KI10,<TRZ T,003	;CHANGE ALL KI10 D.P. ARITHMETIC TO DFAD
   164							CAIN T,(<DFAD>_-9)
   165							JRST ACDOUB >	;KI10 DFAD, DFSB, DFMP, OR DFDV
   166	000124'	254 00 0 00 000505'			JRST TJFCL1]	;PROBABLY AN XCT
   167	000125'	405 14 0 00 000007 		ANDI T,7
   168	000126'	254 00 0 14 000127'		JRST TBL(T)
TRAPS	OVER/UNDERFLOW TRAP ROUTINE	MACRO %53B(1156)-1 01:12 26-Jul-84 Page 3
TRAPS	MAC	 7-Mar-73 08:12		V32/01	14-SEP-72	/DLH

   169					;THIS PAGE FOR OVERFLOWS, DIVIDE CHECKS, AND UN-NORMALIZING UNDERFLOWS
   170
   171	000127'	254 00 0 00 000146'	TBL:	JRST AC
   172	000130'	254 00 0 00 000151'		JRST ACLONG
   173	000131'	254 00 0 00 000164'		JRST MEMORY
   174	000132'	254 00 0 00 000136'		JRST BOTH
   175	000133'	254 00 0 00 000146'		JRST AC
   176	000134'	254 00 0 00 000146'		JRST AC
   177	000135'	254 00 0 00 000164'		JRST MEMORY
   178						;JRST BOTH
   179
   180	000136'	261 17 0 17 000000 	BOTH:	PUSH P,(P)		;SAVE ANOTHER COPY
   181	000137'	200 14 0 00 000336'	BOTH1:	MOVE T,TSAVE
   182	000140'	262 17 1 00 000337'		POP P,@ACFLD		;LOAD AC
   183	000141'	262 17 1 00 000341'		POP P,@INST		;LOAD MEMORY
   184	000142'	254 00 0 00 000225'		JRST TJFCL
   185
   186	000143'	350 14 0 00 000337'	AC1:	AOS T,ACFLD
   187	000144'	405 14 0 00 000017 		ANDI T,17		;MASK AC+1 TO 4 BITS
   188	000145'	202 14 0 00 000337'		MOVEM T,ACFLD
   189	000146'	200 14 0 00 000336'	AC:	MOVE T,TSAVE
   190	000147'	262 17 1 00 000337'		POP P,@ACFLD		;LOAD AC
   191	000150'	254 00 0 00 000225'		JRST TJFCL
   192
   193	000151'	200 14 0 00 000337'	ACLONG:	MOVE T,ACFLD		;GET AC
   194	000152'	271 14 0 00 000001 		ADDI T,1
   195	000153'	405 14 0 00 000017 		ANDI T,17
   196	000154'	202 14 0 00 000341'		MOVEM T,INST		;PUT AC+1 INTO MEMORY ADDRESS
   197	000155'	262 17 0 00 000340'		POP P,ACDATA		;GET SIGN OF ANSWER INTO BETTER PLACE
   198	000156'	261 17 0 00 000516'		PUSH P,[XWD 344777,-1]	;SAVE A POS LOW WORD
   199	000157'	525 14 0 00 377777 		HRLOI T,377777		;ASSUME A POSITIVE HIGH WORD
   200	000160'	335 00 0 00 000340'		SKIPGE ACDATA		;SHOULD RESULT BE POSITIVE?
   201	000161'	131 14 0 17 000000 		KADFN T,(P)		;NO, NEGATE IT WITH KA10 DFN
   202	000162'	261 17 0 00 000014 		PUSH P,T		;PUT OTHER ARG ON PDL
   203	000163'	254 00 0 00 000137'		JRST BOTH1
   204
   205	000164'	200 14 0 00 000336'	MEMORY:	MOVE T,TSAVE
   206	000165'	262 17 1 00 000341'		POP P,@INST
   207	000166'	254 00 0 00 000225'		JRST TJFCL
   208
   209					IFN KI10,<
   210	000167'	205 14 0 00 000740 	ACDOUB:	MOVSI T,(Z 17,)		;GET ONES IN AC FIELD
   211	000170'	404 14 1 00 000030'		AND T,@OVTRAP		;EXTRACT AC FIELD FROM FAULTING D.P. INST
   212	000171'	434 14 0 00 000521'		IOR T,[DMOVE 0,[EXP <377777,,777777>,<377777,,777777>]]
   213	000172'	335 00 0 00 000340'		SKIPGE ACDATA		;WAS OVERFLOW RESULT POSITIVE?
   214	000173'	641 14 0 00 001000 		TLC T,1000		;NO, CHANGE THE DMOVE TO DMOVN
   215	000174'	254 00 0 00 000223'		JRST UAC2 >		;GO FIXUP THE TWO AC'S
TRAPS	OVER/UNDERFLOW TRAP ROUTINE	MACRO %53B(1156)-1 01:12 26-Jul-84 Page 4
TRAPS	MAC	 7-Mar-73 08:12		V32/01	14-SEP-72	/DLH

   216					;THIS PAGE ONLY FOR ZEROING UNDERFLOWS
   217
   218	000175'	254 00 0 00 000220'	UTBL:	JRST UAC		;ZERO AC
   219	000176'	254 00 0 00 000214'		JRST UACLNG		;ZERO AC, AC+1
   220	000177'	254 00 0 00 000210'		JRST UMEMRY		;ZERO E
   221	000200'	254 00 0 00 000204'		JRST UBOTH		;ZERO AC,E
   222	000201'	254 00 0 00 000220'		JRST UAC
   223	000202'	254 00 0 00 000220'		JRST UAC
   224	000203'	254 00 0 00 000210'		JRST UMEMRY
   225						;JRST UBOTH
   226
   227	000204'	200 14 1 00 000030'	UBOTH:	MOVE T,@OVTRAP		;GET OFFENDING INSTRUCTION
   228	000205'	621 14 0 00 777000 		TLZ T,777000		;ZERO OP CODE
   229	000206'	661 14 0 00 403000 		TLO T,(SETZB)		;CHANGE TO "SETZB AC,E"
   230	000207'	254 00 0 00 000223'		JRST UAC2
   231
   232	000210'	200 14 1 00 000030'	UMEMRY:	MOVE T,@OVTRAP
   233	000211'	621 14 0 00 777740 		TLZ T,777740		;ZERO OP CODE, AC FIELD
   234	000212'	661 14 0 00 402000 		TLO T,(SETZM)		;CHANGE TO "SETZM E"
   235	000213'	254 00 0 00 000223'		JRST UAC2
   236
   237	000214'				UACLNG:
   238					IFE KI10,<LDB T,[POINT 4,@OVTRAP,12]	;GET AC FIELD
   239						DPB T,[POINT 4,T,12]	;COPY INTO AC FIELD
   240						ADDI T,1		;CHANGE AC TO AC+1
   241						TRZ T,20		;MASK TO 4 BITS
   242						TLO T,(SETZB) >		;CHANGE TO "SETZB AC,AC+1"
   243	000214'	205 14 0 00 000740 	IFN KI10,<MOVSI T,(Z 17,)	;GET ONES IN AC FIELD
   244	000215'	404 14 1 00 000030'		AND T,@OVTRAP		;EXTRACT AC FIELD FROM FAULTING INST
   245	000216'	434 14 0 00 000524'		IOR T,[DMOVE 0,[EXP 0,0]] >	;SET UP A DMOVE TO CLEAR 2 AC'S
   246	000217'	254 00 0 00 000223'		JRST UAC2
   247
   248	000220'	510 14 1 00 000030'	UAC:	HLLZ T,@OVTRAP		;GET OFFENDING INSTRUCTION
   249	000221'	621 14 0 00 777037 		TLZ T,777037		;ZERO OP CODE, XR,@, LEAVE AC
   250	000222'	661 14 0 00 400000 		TLO T,(SETZ)		;CHANGE TO "SETZ AC,"
   251	000223'	250 14 0 00 000336'	UAC2:	EXCH T,TSAVE		;SAVE INSTRUCTION, RESTORE T
   252	000224'	256 00 0 00 000336'		XCT TSAVE		;CLEAR THE REQUIRED REGISTERS
   253
   254	000225'	202 14 0 00 000336'	TJFCL:	MOVEM T,TSAVE		;SAVE T AGAIN
   255	000226'	350 00 0 00 000030'	TJFCL1:	AOS OVTRAP		;JOBTPC POINTS TO NEXT INSTRUCTION
   256	000227'	200 14 1 00 000030'		MOVE T,@OVTRAP		;GET NEXT INSTRUCTION
   257	000230'	641 14 0 00 255000 		TLC T,(<JFCL>)		;COMPLEMENT "JFCL" BITS
   258	000231'	603 14 0 00 777000 		TLNE T,777000		;JFCL INSTRUCTION?
   259	000232'	254 00 0 00 000244'		JRST ERRPNT		;NO, PRINT ERROR MESSAGE
   260	000233'	602 14 0 00 777777 		TRNE T,-1		;ADDRESS SPECIFIED ON JFCL?
   261	000234'	542 14 0 00 000030'		HRRM T,OVTRAP		;YES, GO THERE
   262	000235'	603 14 0 00 000401 		TLNE T,(<Z 10,(1)>)	;IS OVERFLOW BIT (OR XR1) SET IN JFCL?
   263	000236'	254 00 0 00 000244'		JRST ERRPNT		;YES, TYPE ERROR MESSAGE
   264	000237'	254 02 1 00 000525'	RETURN:	JRSTF	@[XWD 004000,.+1] ;CLEAR APR FLAGS
   265	000240'	525 14 0 00 337600 	GO:	HRLOI T,337600		;MASK OUT SOME FLAGS
   266	000241'	406 14 0 00 000030'		ANDM T,OVTRAP		;BUT LEAVE CRY0, CRY1, AND USER IOT SET
   267	000242'	200 14 0 00 000336'		MOVE T,TSAVE		;RESTORE T
   268	000243'	254 02 1 00 000030'		JRSTF @OVTRAP
TRAPS	OVER/UNDERFLOW TRAP ROUTINE	MACRO %53B(1156)-1 01:12 26-Jul-84 Page 5
TRAPS	MAC	 7-Mar-73 08:12		V32/01	14-SEP-72	/DLH

   269			700000		%OP==(7B2)
   270			000000		IFE REENT,<%L==0>
   271					IFN REENT,<%L==(1B5)>
   272			000005		%O==5
   273			000010		%E==10
   274			000003		%%CR==3
   275
   276	000244'	200 14 0 00 000054*	ERRPNT:	MOVE T,OVPC.(LOW)	;GET FLAGS
   277	000245'	607 14 0 00 000100 		TLNN T,(FXU)
   278	000246'	350 00 0 00 000026*		AOS OVCNT.(LOW)		;COUNT OVERFLOWS AND DIVIDE CHECKS
   279	000247'	607 14 0 00 040000 		TLNN T,(FOV)		;FLOATING POINT TRAP?
   280						JRST	[HRRI T,1	;NO, ASSUME INTEGER OVERFLOW
   281							TLNE T,(NDV)	;INTEGER DIVIDE CHECK?
   282							MOVEI T,2	;YES
   283	000250'	254 00 0 00 000526'			JRST MSG2]
   284	000251'	541 14 0 00 000003 		HRRI T,3		;ASSUME FLOATING POINT OVERFLOW
   285	000252'	603 14 0 00 000040 		TLNE T,(NDV)		;FLOATING DIVIDE CHECK?
   286	000253'	201 14 0 00 000005 		MOVEI T,5		;YES
   287	000254'	603 14 0 00 000100 		TLNE T,(FXU)		;FLOATING UNDERFLOW?
   288	000255'	201 14 0 00 000004 		MOVEI T,4		;YES
   289	000256'	553 00 0 00 000014 	MSG2:	HRRZS	T		;MAKE SURE LEFT HALF IS CLEAR
   290	000257'	261 17 0 00 000001 		PUSH	P,1
   291	000260'	261 17 0 00 000002 		PUSH	P,2
   292	000261'	261 17 0 00 000003 		PUSH	P,3
   293	000262'	550 01 0 00 000244*		HRRZ	1,OVPC.(LOW)	;GET ADDRESS
   294	000263'	317 01 0 00 000000*		CAMG	1,.JBREL	;SKIP IF FROM HIGH SEGMENT
   295	000264'	256 00 0 00 000000*		XCT	UUOL.(LOW)	;SET UP AC16 IF REENT OP SYSTEM
   296	000265'	260 17 0 00 000000*		PUSHJ	P,ITYPM.
   297	000266'	700400	000014			%E,	T	(%OP)
   298	000267'	700263	000262*			%O,	@OVPC.	(%OP+%L+%%CR)
   299	000270'	550 01 0 00 000267*		HRRZ	1,OVPC.(LOW)	;GET ADDRESS
   300	000271'	317 01 0 00 000263*		CAMG	1,.JBREL	;SKIP IF FROM HIGH SEGMENT
   301	000272'	256 00 0 00 000264*		XCT	UUOL.(LOW)	;RESTORE AC16 AGAIN
   302	000273'	262 17 0 00 000003 		POP	P,3
   303	000274'	262 17 0 00 000002 		POP	P,2
   304	000275'	262 17 0 00 000001 		POP	P,1
   305	000276'	254 00 0 00 000237'		JRST	RETURN
   306
   307			000003		TIMCHN=3 ;INTERRUPT CHANNEL USED FOR TIMER
   308
   309					;ROUTINE TO ALLOW USER TO SPECIFY A MAXIMUM CPU TIME IN SECONDS.
   310					;CALLING SEQUENCE IS 
   311					;	CALL TIMER (TIME)
   312					;WHERE TIME IS THE MAX RUN TIME IN INTEGER SECONDS.
   313
   314	000277'	000000	000000		TIMER:	0
   315	000300'	200 00 1 16 000000 		MOVE	0,@0(16)	;GET TIME ARGUMENT
   316	000301'	221 00 0 00 000074 		IMULI	0,^D60		;CONVERT TIME TO TICKS
   317	000302'	202 00 0 00 000334'		MOVEM	0,MAXTIM	;STORE
   318	000303'	402 00 0 00 000335'		SETZM	NOWTIM		;CLEAR TO DATE TIME
   319	000304'	332 00 0 00 000033*		SKIPE	KA10.(LOW)
   320	000305'	254 00 0 00 000320'		JRST	KATIME
   321	000306'	201 00 0 00 000324'		MOVEI	0,TIMINT	;TIMER INTERRUPT ROUTINE
   322	000307'	202 00 0 00 000347'		MOVEM	0,INTAB.+<TIMCHN-1>*2+1 ;STORE IN INTERRUPT TABLE
   323	000310'	201 00 0 00 000003 		MOVEI	0,TIMCHN
TRAPS	OVER/UNDERFLOW TRAP ROUTINE	MACRO %53B(1156)-1 01:12 26-Jul-84 Page 5-1
TRAPS	MAC	 7-Mar-73 08:12		V32/01	14-SEP-72	/DLH

   324	000311'	505 00 0 00 000001 		HRLI	0,1		;INTERRUPT CAUSE IS CLOCK INTERRUPT
   325	000312'	047 00 0 00 777742 		INTASS	0,		;ASSIGN CHANNEL(3) TO CAUSE(1)
   326	000313'	254 04 0 00 000000 		HALT
   327	000314'	200 00 0 00 000532'		MOVE	0,[1B0+1B<TIMCHN>]
   328	000315'	047 00 0 00 777744 		INTENB	0,		;ENABLE TIMER CHANNEL
   329	000316'	254 04 0 00 000000 		HALT
   330	000317'	267 16 0 16 000000 		JRA	16,0(16)	;RETURN
   331	000320'	254 02 1 00 000533'	KATIME:	JRSTF	@[XWD 004000,.+1];CLEAR APR FLAGS
   332	000321'	201 00 0 00 401010 		MOVEI	0,401010	;SET CLOCK AND OVERFLOW TRAPS
   333	000322'	047 00 0 00 000016 		APRENB	0,		;ENABLE
   334	000323'	267 16 0 16 000000 		JRA	16,0(16)	;RETURN
   335
   336	000324'	202 14 0 00 000336'	TIMINT:	MOVEM	T,TSAVE		;NEED A REGISTER
   337	000325'	350 14 0 00 000335'		AOS	T,NOWTIM	;INCREMENT TICK COUNTER
   338	000326'	311 14 0 00 000334'		CAML	T,MAXTIM	;TIME ELAPSED?
   339	000327'	254 00 0 00 000332'		JRST	NOTIME		;YES - ERROR MESSAGE
   340	000330'	200 14 0 00 000336'		MOVE	T,TSAVE		;RESTORE REGISTER
   341	000331'	047 00 0 00 777755 		DISMIS			;RETURN TO PROGRAM
   342	000332'				NOTIME:	TTCALL	3,[ASCIZ/
   343					MAXIMUM RUN TIME EXCEEDED
   344	000332'	051 03 0 00 000534'	/]
   345	000333'	047 01 0 00 000012 		CALLI	1,12		;EXIT WITH CHANNELS OPEN
   346	000334'				MAXTIM:	BLOCK	1		;MAXIMUM RUN TIME IN TICKS
   347	000335'				NOWTIM:	BLOCK	1		;RUN TIME TO DATE IN TICKS
   348	000336'				TSAVE:	BLOCK 1		;TEMP FOR AC T
   349	000337'				ACFLD:	BLOCK 1		;ADDRESS OF ACCUMULATOR
   350	000340'				ACDATA:	BLOCK 1		;HOLDS SIGN OF CORRECT ANSWER
   351	000341'				INST:	BLOCK 1		;HOLDS INSTRUCTION OR "E"
   352	000342'				INTAB.:	BLOCK ^D70	;INTERRUPT SYSTEM TABLE
   353
   354
TRAPS	OVER/UNDERFLOW TRAP ROUTINE	MACRO %53B(1156)-1 01:12 26-Jul-84 Page 6
TRAPS	MAC	 7-Mar-73 08:12		V32/01	14-SEP-72	/DLH

   355					REPEAT 0,<
   356					
   357					DESCRIPTION OF "TRAPS" PROGRAM FOR LIB40-
   358					
   359					I. THE PURPOSE OF THE TRAPS PROGRAM IS DO ERROR DETECTION
   360					   AND CORRECTION WHEN ARITHMETIC FAULTS OCCUR DURING THE
   361					   EXECUTION OF FORTRAN PROGRAMS.
   362					
   363					II. THE TRAPS PROGRAM CONSISTS OF THREE DISTINCT PARTS:
   364					
   365						A. TRPINI
   366							1. CALLING SEQUENCE- PUSHJ P,TRPINI
   367											;RETURN
   368							2. THE OVERFLOW COUNTER, OVCNT, (USED BY THE OVERFL
   369							      FUNCTION) AND THE PC WORD FLAGS ARE CLEARED
   370							3. PROCESSOR AND MONITOR TRAPPING ON OVERFLOW (PC WORD
   371							      BIT 0) IS ENNABLED
   372					
   373						B. OVERFL IS THE STANDARD FORTRAN OVERFLOW FUNCTION
   374							AND EXISTS IN LIB40 AS OVERFL.
   375							1. CALLING SEQUENCE-	JSA 16,OVERFL
   376										ARG	J
   377											;RETURN
   378							2. IF OVCNT=0, THEN J_1
   379							3. IF OVCNT=/0, THEN J_2
   380							4. THE OVERFLOW COUNTER, OVCNT, IS CLEARED TO 0
   381					
   382						C. OVTRAP IS A USER-MODE INTERRUPT ROUTINE WHICH IS STARTED
   383						  BY THE MONITOR WHEN AN ARITHMETIC FAULT OCCURS
   384							1. THE PC WORD (WITH THE ADDRESS OF THE INSTRUCTION
   385							      CAUSING THE TRAP) IS STORED IN OVPC.
   386							2. FOR FLOATING POINT INSTRUCTIONS
   387								A. FOR OVERFLOWS AND DIVIDE CHECKS,
   388								    THE FAULTY ANSWER IS PATCHED
   389								   TO BE PLUS OR MINUS (THE SIGN WILL BE THAT
   390								   OF THE CORRECT ANSWER)THE LARGEST POSSIBLE
   391								   NUMBER.
   392								B. FOR UNDERFLOWS, THE FAULTY ANSWER IS NORMALLY
   393								   PATCHED TO BE 0. HOWEVER, IF THE INSTRUCTION
   394								   FOLLOWING THE TRAPPING INSTRUCTION IS A JFCL
   395								   WITH BIT 16 (XR2) SET, THE ANSWER WILL BE
   396								   UN-NORMALIZED ENOUGH TO BRING THE EXPONENT
   397								   BACK INTO RANGE.
   398							3. (FOR INTEGER INSTRUCTIONS, NO PATCHING OF ANSWERS
   399							      IS DONE.)
TRAPS	OVER/UNDERFLOW TRAP ROUTINE	MACRO %53B(1156)-1 01:12 26-Jul-84 Page 7
TRAPS	MAC	 7-Mar-73 08:12		V32/01	14-SEP-72	/DLH

   400							4. IF THE INSTRUCTION AFTER THE TRAPPING INSTRUCTION
   401							      IS JFCL
   402							      A. DO NOT TYPE AN ERROR MESSAGE
   403								 UNLESS BIT 9 (AR OV TEST BIT) OR 17 (XR1) IS 1
   404							      B. DO NOT INDEX THE OVERFLOW COUNTER OVCNT
   405							      C. IF THE ADDRESS (BITS 18-35) OF THE JFCL
   406								 ARE NON-ZERO, THE INTERRUPTED PROGRAM WILL
   407								 BE RESTARTED AT THE ADDRESS OF THE JFCL
   408								  (THE @ AND INDEX FIELDS ARE IGNORED).
   409							      D. IF THE ADDRESS OF THE JFCL IS ZERO, THE
   410								 INTERRUPTED PROGRAM WILL BE RESTARTED AT
   411								 THE JFCL
   412								E. IF BIT 16 (XR2) IS A 1, UN-NORMALIZE THE
   413								   FRACTION BITS FOR UNDERFLOWS IN ORDER TO
   414								   BRING THE EXPONENT BACK INTO RANGE.
   415							5. IF THE INSTRUCTION AFTER THE TRAPPING INSTRUCTION
   416							      IS NOT JFCL
   417							      A. INDEX THE OVERFLOW COUNTER, OVCNT
   418							      B. TYPE AN ERROR MESSAGE, USING SUBROUTINE "ERRMSG",
   419								 OF THE FOLLOWING FORM:
   420					
   421								INTEGER     OVERFLOW
   422								FLOATING    UNDERFLOW	PC=NNNNNN
   423								FLOATING    DIVIDE CHECK
   424					
   425							      C. THE INTERRUPTED PROGRAM WILL BE RESTARTED AT
   426								 THE INSTRUCTION AFTER THE TRAPPING INSTRUCTION
   427							6. THE PROCESSOR FLAGS (PC WORD FLAGS) ARE CLEARED
   428								EXCEPT FOR CRY0 AND CRY1.
   429							7. THE INTERRUPTED PROGRAM IS RESTARTED
   430					
TRAPS	OVER/UNDERFLOW TRAP ROUTINE	MACRO %53B(1156)-1 01:12 26-Jul-84 Page 8
TRAPS	MAC	 7-Mar-73 08:12		V32/01	14-SEP-72	/DLH

   431					III. LIMITATIONS
   432					
   433						A. OVTRAP FIXUPS WILL NOT WORK ON THE PDP-6 FOR-
   434							1. THE LOW ORDER WORD OF FXXRL OR FXXL INSTRUCTIONS
   435							2. EXPONENT UNDERFLOW OR DIVIDE CHECK TRAPS
   436					
   437						B. FLOATING POINT FIX UPS WILL NOT OCCUR FOR INSTRUCTIONS
   438						   THAT ARE EXECUTED BY AN XCT OR A UUO, OR FOR INSTRUCTIONS
   439						   THAT ARE IN ACCUMULATOR T=14
   440					
   441					
   442						C. THE MEMORY FIX UPS FOR THE FLOATING POINT INSTRUCTIONS
   443						   WILL NOT WORK PROPERLY IF THE ANSWER IS STORED INDEXED
   444						   BY 17 (THE PUSH DOWN POINTER). EXAMPLES:
   445					
   446								FADRM AC,(17)
   447								FMPRB AC,-2(17)
   448								FDVM  AC,+1(17)
   449					
   450						D. MOVNX AND MOVMX ARE INTEGER INSTRUCTIONS AND WILL HAVE
   451						   NO FLOATING POINT FIX UPS IF THEY CAUSE OVERFLOW
   452						E. TRAPPING INSTRUCTION MUST NOT BE IN ACCUMULATOR T=14
   453						F. THE SIGN OF F.P. DIVIDE CHECK FIX UPS WILL BE CORRECT
   454						    ONLY WHEN DIVIDING BY ZERO. (THIS IMPLIES THAT THE
   455						    ARGUMENTS FOR DIVIDE CHECKS SHOULD BE NORMALIZED.)
   456					
   457					>	;END REPEAT 0
   458
   459					PRGEND

NO ERRORS DETECTED

PROGRAM BREAK IS 000542
CPU TIME USED 02:05.217

10P CORE USED
TRAPS	OVER/UNDERFLOW TRAP ROUTINE	MACRO %53B(1156)-1 01:12 26-Jul-84 Page S-1
TRAPS	MAC	 7-Mar-73 08:12		SYMBOL TABLE

AC		000146'		UAC2		000223'		
AC1		000143'		UACLNG		000214'		
ACDATA		000340'		UBOTH		000204'		
ACDOUB		000167'		UMEMRY		000210'		
ACFLD		000337'		UTBL		000175'		
ACLONG		000151'		UUOL.		000272'	ext	
APRENB	047000	000016		%%CR		000003	spd	
BOTH		000136'		%E		000010	spd	
BOTH1		000137'		%L		000000	spd	
CONT		000053'		%O		000005	spd	
DISMIS	047000	777755		%OP		700000	spd	
ERRPNT		000244'		.JBAPR		000022'	ext	
FOV	040000	000000		.JBCNI		000041'	ext	
FXU	000100	000000		.JBREL		000271'	ext	
GO		000240'		.JBTPC		000035'	ext	
INST		000341'		
INTAB.		000342'	ent	
INTADR	047000	777745		
INTASS	047000	777742		
INTENB	047000	777744		
ITYPM.		000265'	ext	
KA10.		000304'	ext	
KADFN	131000	000000		
KATIME		000320'		
KATRAP		000021'		
KI10		000001	spd	
LOW		000000		
MAXTIM		000334'		
MEMORY		000164'		
MSG2		000256'		
NDV	000040	000000		
NOTIME		000332'		
NOWTIM		000335'		
OVCNT.		000246'	ext	
OVE		000010		
OVPC.		000270'	ext	
OVTRAP		000030'		
OVTRP1		000072'		
OVTRP2		000074'		
OVTRP3		000120'		
P		000017		
REENT		000000	spd	
RETURN		000237'		
SETTR1	047000	777740		
T		000014		
TBL		000127'		
TIMCHN		000003		
TIMER		000277'	ent	
TIMINT		000324'		
TJFCL		000225'		
TJFCL1		000226'		
TRPIN.		000000'	ent	
TSAVE		000336'		
TT		000001		
UAC		000220'		
ONINT  ON/OFF INTERRUPT PROCESSING	MACRO %53B(1156)-1 01:12 26-Jul-84 Page 8-1
TRAPS	MAC	 7-Mar-73 08:12	

   460					TITLE ONINT  ON/OFF INTERRUPT PROCESSING
   461
   462			000000		REENT==0
   463			000000		IFE REENT,<LOW=0>
   464					IFN REENT,<LOW=16>
   465
   466			000002		ESCCHN=2 ;CHANNEL FOR ESCAPE INTERRUPT
   467
   468					ENTRY ONINT,OFFINT
   469					EXTERN INTAB.,TRAPF.,DSESC.
   470
   471					;THE ROUTINE ONINT(LABEL) ASSIGNS 'LABEL' AS THE LOCATION TO GO TO
   472					;WHEN AN ESCAPE IS HIT.  THE CALL OFFINT OF NO ARGUMENTS REMOVES THIS
   473					;ASSIGNMENT.
   474
   475	000000'	000000	000000		ONINT:	0
   476	000001'	550 00 0 16 000000 		HRRZ	0,0(16)	;GET ESCAPE LABEL
   477	000002'	202 00 0 00 000037'		MOVEM	0,ESCLAB	;SAVE FOR WHEN ESCAPE IS HIT
   478	000003'	201 00 0 00 000032'		MOVEI	0,ESCINT	;ADDRESS OF ESCAPE PROCESSOR
   479	000004'	202 00 0 00 000000#		MOVEM	0,INTAB.+<ESCCHN-1>*2+1 ;STORE IN CHANNEL TABLE
   480	000005'	402 00 0 00 000000*		SETZM	DSESC.(LOW)	;CLEAR DISABLED FLAG
   481	000006'	200 00 0 00 000000*		MOVE	0,TRAPF.(LOW)	;SIGNAL THAT TRAP ARMED
   482	000007'	660 00 0 00 000002 		TRO	0,1B<36-ESCCHN>	;SET BIT IN RIGHT HALF OF TRAP WORD
   483	000010'	202 00 0 00 000006*		MOVEM	0,TRAPF.(LOW)
   484	000011'	201 00 0 00 777777 		MOVEI	0,-1		;ASSIGN ESCAPE TO COMMAND PORT
   485	000012'	505 00 0 00 000002 		HRLI	0,0_9+ESCCHN	;ASSIGN CAUSE 0 (ESCAPE) TO ESCAPE CHANNEL
   486	000013'	047 00 0 00 777736 		TINASS	0,		;ASSIGN ESCAPE INTERRUPT
   487	000014'	254 04 0 00 000000 		HALT
   488	000015'	200 00 0 00 000040'		MOVE	0,[1B0+1B<ESCCHN>]	;ENABLE ESCAPE CHANNEL
   489	000016'	047 00 0 00 777744 		INTENB	0,
   490	000017'	254 04 0 00 000000 		HALT
   491	000020'	267 16 0 16 000000 		JRA	16,0(16)
   492
   493	000021'	000000	000000		OFFINT:	0
   494	000022'	551 00 0 00 777777 		HRRZI	0,-1
   495	000023'	047 00 0 00 777736 		TINASS	0,		;REMOVE ESCAPE FROM ESCAPE CHANNEL
   496	000024'	254 04 0 00 000000 		HALT
   497	000025'	402 00 0 00 000005*		SETZM	DSESC.(LOW)	;CLEAR DISABLED FLAG
   498	000026'	200 00 0 00 000010*		MOVE	0,TRAPF.(LOW)	;SIGNAL ESCAPE NO LONGER TRAPPED
   499	000027'	620 00 0 00 000002 		TRZ	0,1B<36-ESCCHN>	;CLEAR BIT
   500	000030'	202 00 0 00 000026*		MOVEM	0,TRAPF.(LOW)
   501	000031'	267 16 0 16 000000 		JRA	16,0(16)
   502
   503	000032'	051 12 0 00 000000 	ESCINT:	CLRBFO			;CLEAR TTY OUTPUT BUFFER
   504	000033'	051 11 0 00 000000 		CLRBFI			;CLEAR TTY INPUT BUFFER
   505	000034'	200 00 0 00 000037'		MOVE	0,ESCLAB	;GET ESCAPE LABEL
   506	000035'	542 00 0 00 000000#		HRRM	0,INTAB.+<ESCCHN-1>*2 ;SET IT AS WHERE TO GO AFTER ESCAPE PROCESSING
   507	000036'	047 00 0 00 777755 		DISMIS
   508
   509	000037'				ESCLAB:	BLOCK	1
   510					PRGEND

NO ERRORS DETECTED

PROGRAM BREAK IS 000041
ONINT  ON/OFF INTERRUPT PROCESSING	MACRO %53B(1156)-1 01:12 26-Jul-84 Page 8-2
TRAPS	MAC	 7-Mar-73 08:12	

CPU TIME USED 00:09.257

10P CORE USED
ONINT  ON/OFF INTERRUPT PROCESSING	MACRO %53B(1156)-1 01:12 26-Jul-84 Page S-2
TRAPS	MAC	 7-Mar-73 08:12		SYMBOL TABLE

CLRBFI	051440	000000		
CLRBFO	051500	000000		
DISMIS	047000	777755		
DSESC.		000025'	ext	
ESCCHN		000002		
ESCINT		000032'		
ESCLAB		000037'		
INTAB.		000000	ext	
INTENB	047000	777744		
LOW		000000		
OFFINT		000021'	ent	
ONINT		000000'	ent	
REENT		000000	spd	
TINASS	047000	777736		
TRAPF.		000030'	ext	

TRULIMIT  LIMIT NUMBER OF TRU'S A PROGRAM CAN USE,	MACRO %53B(1156)-1 01:12 26-Jul-84 Page 9
TRAPS	MAC	 7-Mar-73 08:12	

   511					TITLE TRULIMIT  LIMIT NUMBER OF TRU'S A PROGRAM CAN USE,
   512
   513					ENTRY TRULIMIT
   514					EXTERN INTAB.,TRAPF.
   515
   516			000000		REENT==0
   517			000000		IFE REENT,<LOW=0>
   518					IFN REENT,<LOW=16>
   519
   520			000017		P=17
   521
   522			000001		TRUCHN==1	; INTERRUPT CHANNEL USED FOR TRU TRAPPING
   523			000016		.IALIM==16	; INTERRUPT CAUSE FOR TRU LIMIT EXCEEDED
   524			000002		.SLINC==2	; Function 2 (increment current tru charges)
   525		047000	777630		OPDEF	SETLIM	[CALLI -150]	; Set TRU limit
   526
   527					;THE CALL
   528					;	CALL TRULIMIT(TRUS,LABEL)
   529					;
   530					;WHERE LABEL IS WHERE TO GO TO WHEN THE PROGRAM HAS USED TRUS TRU'S.
   531
   532	000000'	000000	000000		TRULIMIT: 0
   533	000001'	551 00 1 16 000001 		HRRZI	0,@1(16)	;GET LABEL TO GO TO ON TRU LIMIT EXCEEDED
   534	000002'	202 00 0 00 000034'		MOVEM	0,TRULAB
   535	000003'	200 00 1 16 000000 		MOVE	0,@0(16)	;Get number of TRUs to increment by
   536	000004'	621 00 0 00 777000 		TLZ	0,(<-1>B8)	;Clear function bits
   537	000005'	661 00 0 00 002000 		TLO	0,(<.SLINC>B8)	;Set function 2, increment TRUs by limit
   538	000006'	047 00 0 00 777630 		SETLIM	0,		;Attempt to set it
   539	000007'	254 00 0 00 000024'		  JRST	EXCEED		; No, some problem - take trap.
   540	000010'	201 00 0 00 000027'		MOVEI	0,TRUINT	;Address of TRU interrupt routine
   541	000011'	202 00 0 00 000000#		MOVEM	0,INTAB.+<TRUCHN-1>*2+1
   542	000012'	201 00 0 00 000001 		MOVEI	0,1B<36-TRUCHN>
   543	000013'	412 00 0 00 000000*		ANDCAM	0,TRAPF.(LOW)	;Signal the a trap is set for FORSE
   544	000014'	201 00 0 00 000001 		MOVEI	0,TRUCHN	;INTERRUPT CHANNEL FOR TRU TRAPPING
   545	000015'	505 00 0 00 000016 		HRLI	0,.IALIM	;INTERRUPT CAUSE FOR TRU TRAPPING (16)
   546	000016'	047 00 0 00 777742 		INTASS	0,		;ASSIGN INTERRUPT CHANNEL TO CAUSE
   547	000017'	254 00 0 00 000024'		  JRST	EXCEED		; No, some problem - take trap.
   548	000020'	200 00 0 00 000035'		MOVE	0,[1B0+1B<TRUCHN>]
   549	000021'	047 00 0 00 777744 		INTENB	0,		;ENABLE TIMER INTERRUPT
   550	000022'	254 00 0 00 000024'		  JRST	EXCEED		; No, some problem - take trap.
   551	000023'	267 16 0 16 000000 		JRA	16,0(16)
   552
   553	000024'	200 16 0 00 000034'	EXCEED:	MOVE	16,TRULAB	; Label address to jump to
   554	000025'	505 16 0 00 000000'		HRLI	16,TRULIMIT	; Where to restore AC from
   555	000026'	267 16 0 16 000000 		JRA	16,0(16)
   556
   557	000027'	201 00 0 00 000001 	TRUINT:	MOVEI	0,1B<36-TRUCHN>
   558	000030'	412 00 0 00 000013*		ANDCAM	0,TRAPF.(LOW)	;Signal that TRU trap is dis-armed
   559	000031'	200 00 0 00 000034'		MOVE	0,TRULAB	;LABEL TO GO TO ON LIMIT EXCEEDED
   560	000032'	542 00 0 00 000000#		HRRM	0,INTAB.+<TRUCHN-1>*2
   561	000033'	047 00 0 00 777755 		DISMIS
   562
   563	000034'				TRULAB:	BLOCK	1
   564
   565					PRGEND
TRULIMIT  LIMIT NUMBER OF TRU'S A PROGRAM CAN USE,	MACRO %53B(1156)-1 01:12 26-Jul-84 Page 9-1
TRAPS	MAC	 7-Mar-73 08:12	


NO ERRORS DETECTED

PROGRAM BREAK IS 000036
CPU TIME USED 00:08.167

10P CORE USED
TRULIMIT  LIMIT NUMBER OF TRU'S A PROGRAM CAN USE,	MACRO %53B(1156)-1 01:12 26-Jul-84 Page S-3
TRAPS	MAC	 7-Mar-73 08:12		SYMBOL TABLE

DISMIS	047000	777755		
EXCEED		000024'		
INTAB.		000000	ext	
INTASS	047000	777742		
INTENB	047000	777744		
LOW		000000		
P		000017		
REENT		000000	spd	
SETLIM	047000	777630		
TRAPF.		000030'	ext	
TRUCHN		000001	spd	
TRUINT		000027'		
TRULAB		000034'		
TRULIM		000000'	ent	
.IALIM		000016	spd	
.SLINC		000002	spd	

INTENA	ENABLE AND DISABLE INTERRUPTS	MACRO %53B(1156)-1 01:12 26-Jul-84 Page 9-2
TRAPS	MAC	 7-Mar-73 08:12	

   566					TITLE INTENA	ENABLE AND DISABLE INTERRUPTS
   567
   568					ENTRY	INTENA,INTDIS
   569					EXTERNAL	DSESC.
   570
   571			000000		REENT==0
   572			000000		IFE REENT,<LOW=0>
   573					IFN REENT,<LOW=16>
   574			000017		P==17	;PUSHDOWN POINTER
   575			000002		ESCCHN=2 ;ESCAPE CHANNEL
   576
   577					; CALL INTDISABLE      DISABLE THE ESCAPE AND TRU INTERRUPTS
   578					;
   579					; CALL INTENABLE       ENABLE BOTH INTERRUPTS
   580
   581	000000'	000000	000000		INTENA:	0
   582	000001'	402 00 0 00 000000*	        SETZM   DSESC.(LOW)     ;SIGNAL NOLONGER DISABLED ESCAPE
   583	000002'	200 01 0 00 000014'	        MOVE    1,[1B0+1B<ESCCHN>]
   584	000003'	047 01 0 00 777744 	        INTENB  1,              ;ENABLE ESCAPE
   585	000004'	254 04 0 00 000000 	        HALT
   586	000005'	267 16 0 16 000000 		JRA	16,0(16)
   587
   588	000006'	000000	000000		INTDIS:	0
   589	000007'	200 01 0 00 000015'	        MOVE    1,[1B<ESCCHN>]
   590	000010'	047 01 0 00 777744 	        INTENB  1,              ;DISABLE ESCAPE
   591	000011'	254 04 0 00 000000 	        HALT
   592	000012'	476 00 0 00 000001*	        SETOM   DSESC.(LOW)
   593	000013'	267 16 0 16 000000 		JRA	16,0(16)
   594
   595						END

NO ERRORS DETECTED

PROGRAM BREAK IS 000016
CPU TIME USED 00:03.466

10P CORE USED
INTENA	ENABLE AND DISABLE INTERRUPTS	MACRO %53B(1156)-1 01:12 26-Jul-84 Page S-4
TRAPS	MAC	 7-Mar-73 08:12		SYMBOL TABLE

DSESC.		000012'	ext	
ESCCHN		000002		
INTDIS		000006'	ent	
INTENA		000000'	ent	
INTENB	047000	777744		
LOW		000000		
P		000017	spd	
REENT		000000	spd	


TRAPS	OVER/UNDERFLOW TRAP ROUTINE	MACRO %53B(1156)-1 01:12 26-Jul-84 Page 1
TRAPS	MAC	 7-Mar-73 08:12		V32/01	14-SEP-72	/DLH


Symbol cross reference

AC	   159	   171	   175	   176	   189#
AC1	   161	   186#
ACDATA	   132	   136	   151	   162	   197	   200	   213	   350#
ACDOUB	   165	   210#
ACFLD	   117	   130	   182	   186	   188	   190	   193	   349#
ACLONG	   172	   193#
BOTH	   174	   180#
BOTH1	   181#	   203
CONT	    74	    78	    81	    89#
DSESC.	   469#	   480	   497	   569#	   582	   592
ERRPNT	   259	   263	   276#
ESCCHN	   466#	   479	   482	   485	   488	   499	   506	   575#	   583	   589
ESCINT	   478	   503#
ESCLAB	   477	   505	   509#
EXCEED	   539	   547	   550	   553#
FOV	    16#	   114	   279
FXU	    15#	    91	   134	   277	   287
GO	    88	   265#
INST	   119	   121	   122	   131	   183	   196	   206	   351#
INTAB.	    37	    47	   322	   352#	   469#	   479	   506	   514#	   541	   560
INTDIS	   568	   588#
INTENA	   568	   581#
ITYPM.	    40#	   296
KA10.	    40#	    45	    73	   319
KATIME	   320	   331#
KATRAP	    46	    62#
KI10	   106	   163	   209	   238	   243
LOW	    11#	    45	    60	    67	    73	    90	   276	   278	   293	   295	   299	   301	   319	   463#
	   480	   481	   483	   497	   498	   500	   517#	   543	   558	   572#	   582	   592
MAXTIM	    77	    83	   317	   338	   346#
MEMORY	   173	   177	   205#
MSG2	   283	   289#
NDV	    17#	   127	   281	   285
NOTIME	    84	   339	   342#
NOWTIM	    82	   318	   337	   347#
OFFINT	   468	   493#
ONINT	   468	   475#
OVCNT.	    39#	    60	    67	   278
OVE	    19#	    64
OVPC.	    39#	    90	   276	   293	   298	   299
OVTRAP	    57	    62	    70#	    76	    89	   116	   118	   126	   133	   155	   211	   227	   232	   244
	   248	   255	   256	   261	   266	   268
OVTRP1	    92	   114#
OVTRP2	    97	   116#
OVTRP3	   149	   154#
P	    13#	    61	    68	   137	   148	   154	   162	   180	   182	   183	   190	   197	   198	   201
	   202	   206	   290	   291	   292	   296	   302	   303	   304	   520#	   574#
REENT	     7#	    11	    12	   270	   271	   462#	   463	   464	   516#	   517	   518	   571#	   572	   573
RETURN	   264#	   305
T	     9#	    72	    79	    80	    82	    83	    86	    87	    89	    90	    91	    94	    95	    96
TRAPS	OVER/UNDERFLOW TRAP ROUTINE	MACRO %53B(1156)-1 01:12 26-Jul-84 Page 1
TRAPS	MAC	 7-Mar-73 08:12		V32/01	14-SEP-72	/DLH


Symbol cross reference

	    99	   100	   102	   103	   106	   107	   110	   111	   114	   116	   117	   118	   119	   120	   121
	   122	   123	   126	   127	   130	   131	   132	   133	   134	   135	   136	   138	   142	   143
	   145	   146	   150	   152	   153	   154	   155	   156	   157	   158	   160	   163	   164	   167
	   168	   181	   186	   187	   188	   189	   193	   194	   195	   196	   199	   201	   202	   205
	   210	   211	   212	   214	   227	   228	   229	   232	   233	   234	   243	   244	   245	   248
	   249	   250	   251	   254	   256	   257	   258	   260	   261	   262	   265	   266	   267	   276
	   277	   279	   280	   281	   282	   284	   285	   286	   287	   288	   289	   297	   336	   337
	   338	   340
TBL	   168	   171#
TIMCHN	   307#	   322	   323	   327
TIMER	    37	   314#
TIMINT	   321	   336#
TJFCL	   184	   191	   207	   254#
TJFCL1	   101	   109	   115	   166	   255#
TRAPF.	   469#	   481	   483	   498	   500	   514#	   543	   558
TRPIN.	    37	    45#
TRUCHN	   522#	   541	   542	   544	   548	   557	   560
TRUINT	   540	   557#
TRULAB	   534	   553	   559	   563#
TRULIM	   513	   532#	   554
TSAVE	    72	   120	   135	   150	   181	   189	   205	   251	   252	   254	   267	   336	   340	   348#
TT	    10#	    47	    48	    49	    51	    52	    54	    55	    57	    58	    62	    63	    64	    66
	   137	   138	   139	   140	   144	   146	   148
UAC	   104	   218	   222	   223	   248#
UAC2	   215	   230	   235	   246	   251#
UACLNG	   108	   219	   237#
UBOTH	   221	   227#
UMEMRY	   220	   224	   232#
UTBL	   111	   218#
UUOL.	    40#	   295	   301
%%CR	   274#	   298
%E	   273#	   297
%L	   270#	   298
%O	   272#	   298
%OP	   269#	   297	   298
.IALIM	   523#	   545
.JBAPR	    40#	    63
.JBCNI	    38#	    79
.JBREL	    40#	   294	   300
.JBTPC	    40#	    75
.SLINC	   524#	   537
TRAPS	OVER/UNDERFLOW TRAP ROUTINE	MACRO %53B(1156)-1 01:12 26-Jul-84 Page 1
TRAPS	MAC	 7-Mar-73 08:12		V32/01	14-SEP-72	/DLH


Macro/Opdef cross reference

APRENB	    66	    87	   333
CLRBFI	   504
CLRBFO	   503
DISMIS	   341	   507	   561
INTADR	    49	    52
INTASS	   325	   546
INTENB	    55	   328	   489	   549	   584	   590
KADFN	   201
SETLIM	   525#	   538
SETTR1	    58
TINASS	   486	   495   +;\-È